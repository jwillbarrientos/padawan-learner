<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Reels</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        .reel-container {
            position: relative;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }

        /* The magic change ‚Äî enforce vertical reel ratio */
        video {
            position: relative;
            width: 100%;
            height: 100%;
            max-height: 90vh;
            max-width: 50vh; /* Keeps vertical 9:16 style */
            object-fit: cover;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.7);
        }

        .controls {
            position: absolute;
            bottom: 30px;         /* distance from bottom of video */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row;  /* horizontal layout */
            gap: 20px;
            z-index: 10;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.3s;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            z-index: 20;
            transition: background 0.3s;
        }

        .home-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
<button id="home-btn" class="home-button">üè† Home</button>

<div class="reel-container">
    <video id="video-player" autoplay muted playsinline></video>
    <div class="controls">
        <button id="download-btn" class="control-button">‚¨áÔ∏è</button>
        <button id="sound-btn" class="control-button">üîá</button>
        <button id="action-btn" class="control-button">‚≠ê</button>
    </div>
</div>

<script>
    const videoEl = document.getElementById("video-player");
    const downloadBtn = document.getElementById("download-btn");
    const actionBtn = document.getElementById("action-btn");

    let videos = [];
    let currentIndex = 0;
    let isTransitioning = false;

    async function loadVideos() {
        try {
            const savedTag = localStorage.getItem('selectedTag') || 'all';
            const savedList = localStorage.getItem('videoList');

            if (savedList) {
                videos = JSON.parse(savedList);
                console.log(`Loaded ${videos.length} videos from localStorage (tag: ${savedTag})`);
            } else {
                const res = await fetch(`/api/getvideosforreel?tag=${savedTag}`);
                if (!res.ok) throw new Error(`Failed to fetch videos (${res.status})`);
                videos = await res.json();
                console.log(`Fetched ${videos.length} videos for tag "${savedTag}"`);
            }

            if (videos.length > 0) {
                loadVideo(currentIndex);
            } else {
                alert("No videos found for this category.");
            }
        } catch (err) {
            console.error("Error loading videos:", err);
            alert("Error loading videos. Check console for details.");
        }
    }

    function getVideoId(video) {
        if (typeof video === 'object' && video.id) return video.id;
        return video; // fallback if list ever contains plain IDs
    }

    function loadVideo(index) {
        if (!videos[index]) return;
        const videoId = getVideoId(videos[index]);
        videoEl.src = `/api/streamingvideos?id=${videoId}`;
        videoEl.play();
    }

    function showNextVideo() {
        if (isTransitioning) return;
        isTransitioning = true;
        currentIndex = (currentIndex + 1) % videos.length;
        fadeToVideo(currentIndex);
    }

    function showPrevVideo() {
        if (isTransitioning) return;
        isTransitioning = true;
        currentIndex = (currentIndex - 1 + videos.length) % videos.length;
        fadeToVideo(currentIndex);
    }

    function fadeToVideo(index) {
        videoEl.style.transition = "opacity 0.3s";
        videoEl.style.opacity = 0;
        setTimeout(() => {
            loadVideo(index);
            videoEl.style.opacity = 1;
            setTimeout(() => (isTransitioning = false), 300);
        }, 300);
    }

    // Swipe detection
    let startY = 0;
    window.addEventListener('touchstart', e => {
        startY = e.touches[0].clientY;
    });
    window.addEventListener('touchend', e => {
        const endY = e.changedTouches[0].clientY;
        const diffY = startY - endY;
        if (Math.abs(diffY) > 50) {
            diffY > 0 ? showNextVideo() : showPrevVideo();
        }
    });

    // Keyboard controls
    window.addEventListener('keydown', e => {
        if (e.key === 'ArrowUp') showPrevVideo();
        if (e.key === 'ArrowDown') showNextVideo();
    });

    // Download button
    downloadBtn.addEventListener('click', () => {
        const videoId = videos[currentIndex];
        const link = document.createElement('a');
        link.href = `/api/streamingvideos?id=${videoId}`;
        link.download = `video_${videoId}.mp4`;
        document.body.appendChild(link);
        link.click();
        link.remove();
    });

    // Placeholder for your custom action
    actionBtn.addEventListener('click', () => {
        const videoId = videos[currentIndex];
        alert(`Custom action for video: ${videoId}`);
        // Later: replace this with your new feature (like "like", "save", etc.)
    });

    window.addEventListener('wheel', (e) => {
        if (isTransitioning) return;
        if (e.deltaY > 0) {
            showNextVideo();
        } else if (e.deltaY < 0) {
            showPrevVideo();
        }
    });

    const homeBtn = document.getElementById("home-btn");
    homeBtn.addEventListener("click", () => {
        window.location.href = "/app/welcome-page.html"; // change this to your actual welcome page path
    });

    const soundBtn = document.getElementById("sound-btn");
    soundBtn.addEventListener("click", () => {
        videoEl.muted = !videoEl.muted;
        soundBtn.textContent = videoEl.muted ? "üîá" : "üîä";
    });

    // Start app
    loadVideos();
</script>

</body>
</html>
