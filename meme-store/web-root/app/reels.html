<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Reels</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        .reel-container {
            position: relative;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .video-wrapper video {
            position: absolute;
            top: 5vh;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            height: 100%;
            max-height: 90vh;
            max-width: 50vh;
            object-fit: cover;
            border-radius: 12px;
            transition: top 0.45s ease-in-out;
            will-change: top;
        }


        .controls {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row;
            gap: 20px;
            z-index: 10;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 14px 18px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.3s;
        }

        .control-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            z-index: 20;
            transition: background 0.3s;
        }

        .home-button:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
<button id="home-btn" class="home-button">üè† Home</button>

<div class="reel-container">
    <div id="video-wrapper" class="video-wrapper">
        <video id="video-player" autoplay muted playsinline></video>
    </div>
    <div class="controls">
        <button id="download-btn" class="control-button">‚¨áÔ∏è</button>
        <button id="sound-btn" class="control-button">üîá</button>
        <button id="action-btn" class="control-button">‚≠ê</button>
    </div>
</div>

<script>
    // ---- Global elements ----
    let videoEl = document.getElementById("video-player");
    const wrapper = document.getElementById("video-wrapper");
    const downloadBtn = document.getElementById("download-btn");
    const actionBtn = document.getElementById("action-btn");
    const soundBtn = document.getElementById("sound-btn");
    const homeBtn = document.getElementById("home-btn");

    // ---- State ----
    let videos = [];
    let currentIndex = 0;
    let isTransitioning = false;

    // ---- Load videos from API/localStorage ----
    async function loadVideos() {
        try {
            const savedTag = localStorage.getItem('selectedTag') || 'all';
            const savedList = localStorage.getItem('videoList');

            if (savedList) {
                videos = JSON.parse(savedList);
                console.log(`Loaded ${videos.length} videos from localStorage (tag: ${savedTag})`);
            } else {
                const res = await fetch(`/api/getvideosforreel?tag=${savedTag}`);
                if (!res.ok) throw new Error(`Failed to fetch videos (${res.status})`);
                videos = await res.json();
                console.log(`Fetched ${videos.length} videos for tag "${savedTag}"`);
            }

            if (videos.length > 0) {
                loadVideo(currentIndex);
            } else {
                alert("No videos found for this category.");
            }
        } catch (err) {
            console.error("Error loading videos:", err);
            alert("Error loading videos. Check console for details.");
        }
    }

    function getVideoId(video) {
        return typeof video === 'object' && video.id ? video.id : video;
    }

    function loadVideo(index) {
        if (!videos[index]) return;
        const videoId = getVideoId(videos[index]);
        videoEl.src = `/api/streamingvideos?id=${videoId}`;
        videoEl.play();
    }

    // ---- Create and slide video ----
    function createVideoElement(id, inheritMuted = true) {
        const v = document.createElement("video");
        v.src = `/api/streamingvideos?id=${id}`;
        v.autoplay = true;
        v.playsInline = true;
        v.muted = !!inheritMuted;
        v.style.position = "absolute";
        v.style.top = "5vh";
        v.style.left = "50%";
        v.style.transform = "translateX(-50%)";
        v.style.width = "100%";
        v.style.height = "100%";
        v.style.objectFit = "cover";
        v.style.borderRadius = "12px";
        v.style.transition = "top 0.45s ease-in-out";
        v.addEventListener("click", () => {
            if (v.paused) v.play();
            else v.pause();
        });
        return v;
    }

    function slideToVideo(index, direction = "next") {
        if (isTransitioning) return;
        if (!videos[index]) return;
        isTransitioning = true;

        try { videoEl.pause(); } catch (e) {}

        const nextId = getVideoId(videos[index]);
        const newVideo = createVideoElement(nextId, videoEl.muted);

        // Position off-screen
        newVideo.style.top = direction === "next" ? "100%" : "-100%";
        wrapper.appendChild(newVideo);

        // Trigger layout reflow
        void newVideo.offsetHeight;

        // Animate both
        videoEl.style.top = direction === "next" ? "-100%" : "100%";
        newVideo.style.top = "5vh";

        const onTransitionEnd = (ev) => {
            if (ev.propertyName !== "top") return;

            try { videoEl.remove(); } catch (e) {}
            newVideo.id = "video-player";
            videoEl = newVideo;

            try { videoEl.play().catch(()=>{}); } catch(e){}

            newVideo.removeEventListener("transitionend", onTransitionEnd);
            isTransitioning = false;
        };

        newVideo.addEventListener("transitionend", onTransitionEnd);
    }

    function showNextVideo() {
        if (isTransitioning) return;
        currentIndex = (currentIndex + 1) % videos.length;
        slideToVideo(currentIndex, "next");
    }

    function showPrevVideo() {
        if (isTransitioning) return;
        currentIndex = (currentIndex - 1 + videos.length) % videos.length;
        slideToVideo(currentIndex, "prev");
    }

    // ---- Swipe detection ----
    let startY = 0;
    window.addEventListener("touchstart", e => {
        startY = e.touches[0].clientY;
    });
    window.addEventListener("touchend", e => {
        const endY = e.changedTouches[0].clientY;
        const diffY = startY - endY;
        if (Math.abs(diffY) > 50) {
            diffY > 0 ? showNextVideo() : showPrevVideo();
        }
    });

    // ---- Keyboard and wheel controls ----
    window.addEventListener("keydown", e => {
        if (e.key === "ArrowUp") showPrevVideo();
        if (e.key === "ArrowDown") showNextVideo();
    });

    window.addEventListener("wheel", e => {
        if (isTransitioning) return;
        if (e.deltaY > 0) showNextVideo();
        else if (e.deltaY < 0) showPrevVideo();
    });

    // ---- Control buttons ----
    downloadBtn.addEventListener("click", () => {
        const id = getVideoId(videos[currentIndex]);
        const link = document.createElement("a");
        link.href = `/api/streamingvideos?id=${id}`;
        link.download = `video_${id}.mp4`;
        document.body.appendChild(link);
        link.click();
        link.remove();
    });

    actionBtn.addEventListener("click", () => {
        const id = getVideoId(videos[currentIndex]);
        alert(`Custom action for video: ${id}`);
    });

    soundBtn.addEventListener("click", () => {
        if (!videoEl) return;
        videoEl.muted = !videoEl.muted;
        soundBtn.textContent = videoEl.muted ? "üîá" : "üîä";
    });

    homeBtn.addEventListener("click", () => {
        window.location.href = "/app/welcome-page.html"; // Change to your real path
    });

    // ---- Click to pause/play ----
    videoEl.addEventListener("click", () => {
        if (videoEl.paused) videoEl.play();
        else videoEl.pause();
    });

    // ---- Start ----
    loadVideos();
</script>
</body>
</html>
